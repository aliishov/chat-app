<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>STOMP Chat Test</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f4f4f4;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        button {
            padding: 10px 15px;
            margin: 5px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #45a049;
        }
        input {
            padding: 10px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .message-box, .online-users, .chat-box {
            height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            background: #f9f9f9;
            white-space: pre-wrap;
            margin-bottom: 20px;
        }
        .chat-box {
            background: #e9ecef;
        }
        .chat-message {
            padding: 8px;
            margin: 5px 0;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .chat-message:hover {
            background-color: #d1e7dd;
        }
        .sent { background-color: #d1e7dd; }
        .delivered { background-color: #cfe2ff; }
        .read { background-color: #d1f5d3; }
        .hidden { display: none; }
    </style>
</head>
<body>
<div class="container">
    <div id="loginForm">
        <h2>Login</h2>
        <input type="text" id="loginEmail" placeholder="Email" required>
        <input type="password" id="loginPassword" placeholder="Password" required>
        <button onclick="login()">Login</button>
    </div>
    <div id="chatInterface" class="hidden">
        <h2>Welcome, <span id="userName"></span></h2>
        <div>
            <button onclick="connect()" id="connectBtn">Connect</button>
            <button onclick="disconnect()" id="disconnectBtn" disabled>Disconnect</button>
        </div>
        <div>
            <h3>Online Users</h3>
            <div id="onlineUsers" class="online-users"></div>
        </div>
        <div>
            <h3>Send Message</h3>
            <input type="text" id="message" placeholder="Message content..."/>
            <input type="text" id="recipientId" placeholder="Recipient UUID"/>
            <button onclick="sendMessage()">Send</button>
        </div>
        <div>
            <h3>Inbound System Messages</h3>
            <pre id="topicMessages" class="message-box"></pre>
        </div>
        <div>
            <h3>Chat</h3>
            <div id="chatBox" class="chat-box"></div>
        </div>
        <button onclick="logout()">Logout</button>
    </div>
</div>

<script>
    let stompClient = null;
    let jwtToken = null;
    const senderId = "ea73a010-7a75-42a7-a345-b97bc10841bd";

    function logMessage(messageDto, isTopic) {
        const target = isTopic ? document.getElementById("topicMessages") : document.getElementById("chatBox");
        if (isTopic) {
            target.textContent += JSON.stringify(messageDto, null, 2) + "\n";
            target.scrollTop = target.scrollHeight;
        } else {
            const messageDiv = document.createElement("div");
            messageDiv.className = `chat-message ${messageDto.status.toLowerCase()}`;
            messageDiv.dataset.messageId = messageDto.messageId;
            messageDiv.innerHTML = `
                    Content: ${messageDto.content}<br>
                    Sender: ${messageDto.senderId}<br>
                    Status: ${messageDto.status}<br>
                    Sent at: ${messageDto.sentAt}<br>
                    Delivered at: ${messageDto.deliveredAt || 'Not delivered'}<br>
                    Read at: ${messageDto.readAt || 'Not read'}
                `;
            messageDiv.onclick = () => {
                if (messageDto.status !== 'READ') {
                    stompClient.send("/app/update-status", { 'Authorization': 'Bearer ' + jwtToken }, JSON.stringify({
                        messageId: messageDto.messageId,
                        status: "READ"
                    }));
                }
            };
            target.appendChild(messageDiv);
            target.scrollTop = target.scrollHeight;
        }
    }

    function login() {
        const email = document.getElementById("loginEmail").value;
        const password = document.getElementById("loginPassword").value;
        fetch('http://localhost:8080/api/v1/auth/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email, password })
        })
            .then(response => response.json())
            .then(data => {
                jwtToken = data.accessToken;
                document.getElementById("userName").textContent = data.user.firstName + ' ' + data.user.lastName;
                document.getElementById("loginForm").classList.add("hidden");
                document.getElementById("chatInterface").classList.remove("hidden");
            })
            .catch(error => console.error("Login error:", error));
    }

    function connect() {
        if (stompClient || !jwtToken) return;
        const socket = new SockJS('http://localhost:8080/ws');
        stompClient = Stomp.over(socket);
        stompClient.connect({'Authorization': 'Bearer ' + jwtToken}, (frame) => {
            document.getElementById("connectBtn").disabled = true;
            document.getElementById("disconnectBtn").disabled = false;
            logMessage({ status: "Connected", frame: frame }, true);

            // Подписка на онлайн-пользователей
            stompClient.subscribe('/topic/online-users', (message) => {
                const onlineUsers = JSON.parse(message.body);
                updateOnlineUsers(onlineUsers);
            });
            stompClient.send('/app/online-users', { 'Authorization': 'Bearer ' + jwtToken }, JSON.stringify({}));

            // Подписка на чат (используем фиксированный chatRoomId = '2' пока)
            stompClient.subscribe('/chat-rooms/2/queue/messages', (message) => {
                const messageDto = JSON.parse(message.body);
                logMessage(messageDto, false);
                if (messageDto.status === "SENT" && messageDto.messageId) {
                    stompClient.send("/app/update-status", { 'Authorization': 'Bearer ' + jwtToken }, JSON.stringify({
                        messageId: messageDto.messageId,
                        status: "DELIVERED"
                    }));
                }
            });
        }, (error) => {
            logMessage({ status: "Connection Error", error: error }, true);
        });
    }

    function disconnect() {
        if (stompClient) {
            stompClient.disconnect(() => {
                logMessage({ status: "Disconnected" }, true);
                document.getElementById("connectBtn").disabled = false;
                document.getElementById("disconnectBtn").disabled = true;
                stompClient = null;
            });
        }
    }

    function sendMessage() {
        if (!stompClient || !stompClient.connected) {
            logMessage({ status: "Error", message: "Connect first!" }, true);
            return;
        }
        const msg = document.getElementById("message").value.trim();
        const recipientId = document.getElementById("recipientId").value.trim();

        if (!msg) {
            logMessage({ status: "Error", message: "Message content cannot be empty!" }, true);
            return;
        }
        if (!recipientId) {
            logMessage({ status: "Error", message: "Recipient UUID required!" }, true);
            return;
        }

        const payload = {
            content: msg,
            senderId: senderId,
            recipientId: recipientId,
            chatRoomId: "2" // Фиксированный chatRoomId пока
        };

        stompClient.send("/app/chat.send", { 'Authorization': 'Bearer ' + jwtToken }, JSON.stringify(payload));
        logMessage({ status: "Sent", payload: payload }, true);
        document.getElementById("message").value = "";
    }

    function updateOnlineUsers(onlineUsers) {
        const onlineUsersDiv = document.getElementById("onlineUsers");
        onlineUsersDiv.innerHTML = '';
        onlineUsers.forEach(user => {
            if (user.userId !== senderId) {
                const userDiv = document.createElement("div");
                userDiv.textContent = `${user.firstName} ${user.lastName} (Online)`;
                onlineUsersDiv.appendChild(userDiv);
            }
        });
    }

    function logout() {
        disconnect();
        jwtToken = null;
        document.getElementById("chatInterface").classList.add("hidden");
        document.getElementById("loginForm").classList.remove("hidden");
    }

    // События
    document.getElementById("message").addEventListener("keypress", function(e) {
        if (e.key === "Enter" && stompClient && stompClient.connected) {
            sendMessage();
        }
    });

    document.getElementById("recipientId").addEventListener("input", function() {
        if (stompClient && stompClient.connected) {
            const newRecipientId = this.value.trim();
            if (newRecipientId) {
                stompClient.subscribe('/chat-rooms/2/queue/messages', (message) => {
                    const messageDto = JSON.parse(message.body);
                    logMessage(messageDto, false);
                    if (messageDto.status === "SENT" && messageDto.messageId) {
                        stompClient.send("/app/update-status", { 'Authorization': 'Bearer ' + jwtToken }, JSON.stringify({
                            messageId: messageDto.messageId,
                            status: "DELIVERED"
                        }));
                    }
                });
                logMessage({ status: "Subscription updated", recipientId: newRecipientId }, false);
            }
        }
    });
</script>
</body>
</html>